<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Cr√©er une facture</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    .facture-flex-container {
      display: flex;
      align-items: flex-start;
      gap: 30px;
    }
    .facture-main-left {
      flex: 1 1 0;
      min-width: 350px;
    }
    .facture-main-right {
      width: 550px;
      position: sticky;
      top: 25px;
      align-self: flex-start;
      background: #f8f8f8;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      min-height: 400px;
      max-height: 90vh;
      overflow: auto;
    }
    .apercu-bl-title {
      font-weight: bold;
      margin-bottom: 6px;
      font-size: 1.05em;
    }
    .apercu-bl-empty {
      color: #888;
      font-style: italic;
      margin-top: 24px;
      text-align: center;
    }
    .apercu-pdf-viewer {
      width: 100%;
      min-height: 350px;
      height: 60vh;
      border: none;
    }
  </style>
  <script>
    function updatePreview(input) {
      const filePath = input.value;
      const label = input.parentElement.querySelector('label').textContent;
      document.getElementById('apercu-bl-nom').textContent = label;
      document.getElementById('apercu-bl-frame').src = "/static/pdf_proxy?path=" + encodeURIComponent(filePath);
      document.getElementById('apercu-bl-empty').style.display = "none";
      document.getElementById('apercu-bl-body').style.display = "block";
    }
    window.addEventListener('DOMContentLoaded', function() {
      const checked = document.querySelector('input[type=checkbox][name=fichiers]:checked');
      if (checked) updatePreview(checked);
    });
  </script>
</head>
<body>
  <div class="container">
    <h1>üßæ Associer des BL √† une facture</h1>
    <div class="facture-flex-container">
      <!-- Partie gauche -->
      <div class="facture-main-left">
        <form method="GET" action="/facture">
          <label for="mois_filtre">Filtrer par mois</label>
          <select name="mois_filtre" id="mois_filtre">
            <option value="">-- Tous les mois --</option>
            {% for mois in mois_disponibles %}
              <option value="{{ mois }}" {% if mois == mois_selectionne %}selected{% endif %}>{{ mois }}</option>
            {% endfor %}
          </select>
          <label for="client_filtre">Filtrer par client</label>
          <select name="client_filtre" id="client_filtre">
            <option value="">-- Tous les clients --</option>
            {% for client in clients_disponibles %}
              <option value="{{ client }}" {% if client == client_selectionne %}selected{% endif %}>{{ client }}</option>
            {% endfor %}
          </select>
          <button type="submit" style="margin-top:10px;">üîé Filtrer</button>
        </form>
        <form method="POST" enctype="multipart/form-data">
          <label for="nom_facture">Nom de la facture</label>
          <input type="text" name="nom_facture" id="nom_facture" required>
          <label for="bc_file">Ajouter un Bon de Commande (optionnel) :</label>
          <input type="file" name="bc_file" id="bc_file" accept="application/pdf">
          <label for="fichiers">S√©lectionner les BL √† associer :</label>
          {% if fichiers_groupes %}
            {% for date_code, entreprises in fichiers_groupes.items() %}
              <h2>{{ date_code }}</h2>
              {% for entreprise, chantiers in entreprises.items() %}
                <h3 style="margin-left: 10px;">{{ entreprise }}</h3>
                {% for chantier, machines in chantiers.items() %}
                  <h4 style="margin-left: 30px;">{{ chantier }}</h4>
                  {% for machine, fichiers in machines.items() %}
                    <h5 style="margin-left: 50px;">{{ machine }}</h5>
                    <ul style="margin-left: 70px;">
                    {% for chemin, nom in fichiers %}
                      <li>
                        <input type="checkbox" name="fichiers" value="{{ chemin }}" id="{{ chemin }}"
                          onclick="updatePreview(this)">
                        <label for="{{ chemin }}">{{ nom }}</label>
                      </li>
                    {% endfor %}
                    </ul>
                  {% endfor %}
                {% endfor %}
              {% endfor %}
            {% endfor %}
          {% else %}
            <p>Aucun BL archiv√© trouv√© pour ces crit√®res.</p>
          {% endif %}
          <button type="submit" style="margin-top:20px;">üì¶ G√©n√©rer la facture</button>
        </form>
        <p style="margin-top:20px;"><a href="/">‚Üê Retour</a></p>
      </div>
      <!-- Partie droite : Aper√ßu du BL s√©lectionn√© -->
      <div class="facture-main-right">
        <div id="apercu-bl-empty" class="apercu-bl-empty">
          Aucun BL s√©lectionn√©.<br>
          <span style="font-size:.92em;">Cliquez sur un BL pour l‚Äôafficher ici.</span>
        </div>
        <div id="apercu-bl-body" style="display:none;">
          <div class="apercu-bl-title" id="apercu-bl-nom"></div>
          <iframe id="apercu-bl-frame" class="apercu-pdf-viewer"></iframe>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
