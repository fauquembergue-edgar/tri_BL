<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Créer une facture</title>

  <!-- Lien vers le fichier CSS principal -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <!-- Quelques styles supplémentaires spécifiques à cette page -->
  <style>
    body, html {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    /* Conteneur principal avec deux blocs (formulaire + aperçu) */
    .facture-main-wrapper {
      display: flex;
      justify-content: flex-start;
      align-items: stretch;
      height: 100vh;
      min-height: 100vh;
    }

    /* Bloc de gauche : formulaire de génération de facture */
    .facture-ilot-central {
      width: 900px;
      min-width: 400px;
      max-width: 100vw;
      padding: 30px 32px 30px 40px;
      background: #fff;
      box-shadow: 2px 0 8px rgba(0,0,0,0.06);
      border-right: 1.5px solid #eee;
      position: relative;
      z-index: 3;
      overflow-y: auto;
    }

    /* Bloc de droite : aperçu des BL (PDF) */
    .facture-ilot-bl {
      flex: 1 1 0;
      min-width: 700px;
      max-width: 1200px;
      background: #f8f8f8;
      padding: 24px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }

    /* Style du titre de l’aperçu PDF */
    .apercu-bl-title {
      font-weight: bold;
      font-size: 1.06em;
      margin: 10px 0;
      text-align: left;
    }

    /* Texte affiché quand aucun BL n’est sélectionné */
    .apercu-bl-empty {
      color: #888;
      font-style: italic;
      margin-top: 80px;
      text-align: center;
      font-size: 1.15em;
    }

    /* Zone d’aperçu du PDF */
    .apercu-pdf-viewer {
      width: 100%;
      min-height: 600px;
      height: 82vh;
      border: 1px solid #ccc;
      border-radius: 7px;
      background: white;
      box-shadow: 0 2px 18px rgba(0,0,0,0.08);
      margin: 0 auto;
      display: block;
    }

    .container {
      width: 100%;
      padding: 0;
      margin: 0;
      box-sizing: border-box;
    }

    /* Permet à chaque bloc d’avoir son propre scroll vertical */
    .facture-ilot-central, .facture-ilot-bl {
      overflow-y: auto;
      height: 100vh;
    }
  </style>

  <!-- Script pour mettre à jour l’aperçu du BL sélectionné -->
  <script>
    function updatePreview(input) {
      const filePath = input.value;
      const label = input.parentElement.querySelector('label').textContent;
      document.getElementById('apercu-bl-nom').textContent = label;
      document.getElementById('apercu-bl-frame').src = "/static/pdf_proxy?path=" + encodeURIComponent(filePath);
      document.getElementById('apercu-bl-empty').style.display = "none";
      document.getElementById('apercu-bl-body').style.display = "block";
    }

    // Si un BL est déjà coché au chargement, on l’affiche
    window.addEventListener('DOMContentLoaded', function() {
      const checked = document.querySelector('input[type=checkbox][name=fichiers]:checked');
      if (checked) updatePreview(checked);
    });
  </script>
</head>

<body>
  <div class="facture-main-wrapper">
    
    <!-- Partie gauche : formulaire de génération de facture -->
    <div class="facture-ilot-central">
      <h1 style="margin-top: 0;">Associer des BL à une facture</h1>

      <!-- Formulaire de filtre par mois et client -->
      <form method="GET" action="/facture">
        <label for="mois_filtre">Filtrer par mois</label>
        <select name="mois_filtre" id="mois_filtre">
          <option value="">-- Tous les mois --</option>
          {% for mois in mois_disponibles %}
            <option value="{{ mois }}" {% if mois == mois_selectionne %}selected{% endif %}>{{ mois }}</option>
          {% endfor %}
        </select>

        <label for="client_filtre">Filtrer par client</label>
        <select name="client_filtre" id="client_filtre">
          <option value="">-- Tous les clients --</option>
          {% for client in clients_disponibles %}
            <option value="{{ client }}" {% if client == client_selectionne %}selected{% endif %}>{{ client }}</option>
          {% endfor %}
        </select>

        <button type="submit" style="margin-top:10px;">Filtrer</button>
      </form>

      <!-- Formulaire de création de facture avec sélection de fichiers -->
      <form method="POST" enctype="multipart/form-data">
        <label for="nom_facture">Nom de la facture</label>
        <input type="text" name="nom_facture" id="nom_facture" required>

        <label for="bc_file">Ajouter un Bon de Commande (optionnel) :</label>
        <input type="file" name="bc_file" id="bc_file" accept="application/pdf">

        <label for="fichiers">Sélectionner les BL à associer :</label>

        {% if fichiers_groupes %}
          {% for date_code, entreprises in fichiers_groupes.items() %}
            <h2>{{ date_code }}</h2>
            {% for entreprise, chantiers in entreprises.items() %}
              <h3 style="margin-left: 10px;">{{ entreprise }}</h3>
              {% for chantier, machines in chantiers.items() %}
                <h4 style="margin-left: 30px;">{{ chantier }}</h4>
                {% for machine, fichiers in machines.items() %}
                  <h5 style="margin-left: 50px;">{{ machine }}</h5>
                  <ul style="margin-left: 70px;">
                  {% for chemin, nom in fichiers %}
                    <li>
                      <input type="checkbox" name="fichiers" value="{{ chemin }}" id="{{ chemin }}"
                        onclick="updatePreview(this)">
                      <label for="{{ chemin }}">{{ nom }}</label>
                    </li>
                  {% endfor %}
                  </ul>
                {% endfor %}
              {% endfor %}
            {% endfor %}
          {% endfor %}
        {% else %}
          <p>Aucun BL archivé trouvé pour ces critères.</p>
        {% endif %}

        <button type="submit" style="margin-top:20px;">Générer la facture</button>
      </form>

      <p style="margin-top:20px;"><a href="/">← Retour</a></p>
    </div>

    <!-- Partie droite : aperçu dynamique du fichier PDF sélectionné -->
    <div class="facture-ilot-bl">
      <div id="apercu-bl-empty" class="apercu-bl-empty">
        Aucun BL sélectionné.<br>
        <span style="font-size:.92em;">Cliquez sur un BL pour l’afficher ici.</span>
      </div>
      <div id="apercu-bl-body" style="display:none;">
        <div class="apercu-bl-title" id="apercu-bl-nom"></div>
        <iframe id="apercu-bl-frame" class="apercu-pdf-viewer"></iframe>
      </div>
    </div>
  </div>
</body>
</html>
